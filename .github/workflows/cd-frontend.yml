name: CD DevSecOps Frontend

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    name: Build and Push Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:${{ github.sha }} .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:${{ github.sha }}

  deploy-staging:
    name: Deploy to Preproduction
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.EC2_SSH_KEY }}
          known_hosts: unnecessary

      - name: Add EC2 to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p 22 -H ${{ secrets.EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts

      - name: Deploy frontend on EC2 (staging)
        run: |
          ssh ec2-user@${{ secrets.EC2_PUBLIC_IP }} << EOF
            set -euo pipefail
            docker network create ${{ secrets.NETWORK_NAME }} || true
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:${{ github.sha }}
            docker stop ${{ secrets.CONTAINER_NAME_STAGING }} || true
            docker rm ${{ secrets.CONTAINER_NAME_STAGING }} || true
            docker run -d --name ${{ secrets.CONTAINER_NAME_STAGING }} --network ${{ secrets.NETWORK_NAME }} \
              ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          EOF

  run-dast:
    name: Run DAST on Preproduction
    runs-on: self-hosted
    needs: deploy-staging
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Run DAST with ZAP
        shell: powershell
        run: |
          $env:PATH += ";C:\Windows\System32"
          .\dast.bat "%GITHUB_WORKSPACE%"
        env:
          ZAP_URL: http://${{ secrets.EC2_PUBLIC_IP }}
      - name: Check alerts (no fail, just report)
        shell: powershell
        run: |
          if (!(Test-Path "report.json")) { Write-Warning "report.json not found"; exit 0 }
          $json = Get-Content -Raw -Path "report.json" | ConvertFrom-Json
          $sites = if ($json.site -is [System.Array]) { $json.site } else { @($json.site) }
          $alerts = @()
          foreach ($s in $sites) { if ($s.alerts) { $alerts += $s.alerts } }
          $high   = ($alerts | Where-Object { $_.risk -eq "High" -or $_.riskdesc -like "High*" }).Count
          $medium = ($alerts | Where-Object { $_.risk -eq "Medium" -or $_.riskdesc -like "Medium*" }).Count
          Write-Host "ZAP alerts => High: $high, Medium: $medium (Low/Informational ignored)"
          if ($high -gt 0 -or $medium -gt 0) { Write-Warning "Alerts found: High=$high Medium=$medium - Review report.html" } else { Write-Host "No High/Medium alerts" }
      - name: Upload DAST report
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: dast-report
          path: |
            report.html
            report.json

  await-approval:
    name: Await DAST approval
    runs-on: ubuntu-latest
    needs: run-dast
    if: always()                       
    environment: production-approval        
    steps:
      - name: Download DAST report
        uses: actions/download-artifact@v4
        with:
          name: dast-report
      - name: Notify reviewers 
        run: echo "Review DAST report and approve environment to proceed"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: run-dast
    if: needs.run-dast.result == 'success'

    steps:
      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.EC2_SSH_KEY }}
          known_hosts: unnecessary

      - name: Add EC2 prod to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p 22 -H ${{ secrets.EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts

      - name: Clean up Production
        run: |
          ssh ec2-user@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
            docker stop ${{ secrets.CONTAINER_NAME_PROD }} || true
            docker rm ${{ secrets.CONTAINER_NAME_PROD }} || true
          EOF

      - name: Deploy frontend on EC2 (production)
        run: |
          ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=10 ec2-user@${{ secrets.EC2_PUBLIC_IP }} << EOF
            set -euo pipefail
            docker network create ${{ secrets.NETWORK_NAME }} || true
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:${{ github.sha }}
            docker stop ${{ secrets.CONTAINER_NAME_PROD }} || true
            docker rm ${{ secrets.CONTAINER_NAME_PROD }} || true
            docker run -d --name ${{ secrets.CONTAINER_NAME_PROD }} -v /home/ec2-user/logs/frontend:/var/log/nginx --network ${{ secrets.NETWORK_NAME }} \
              ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          EOF